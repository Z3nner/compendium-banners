_id: 3KPsYon0LoANWX54
name: Scan
type: script
author: 2a2IgZ2kiAqXSGqu
img: systems/lancer/assets/icons/macro-icons/tech_quick.svg
scope: global
command: |-
  let targets = Array.from(game.user.targets);

  function sort_features(a, b) {
      return b.Origin.base-a.Origin.base
  }

  function construct_features(sc_dir, o) {
      let sc_list = ``;
      sc_list += `<p>${o}</p>`
      let sc_features = sc_dir._features.filter(f => f.Origin.name == o).sort(sort_features)
      sc_features.forEach(i => {
          let sc_name = ``;
          let sc_desc = ``;
          if (i.Origin.name == "EXOTIC" && !i.Origin.base) {
              sc_name = "<code class=\"horus--subtle\">UNKNOWN EXOTIC SYSTEM</code>";
              sc_desc = "???";
          }
          else {
              sc_name = i.Name;
              if (i.Effect) {
                  sc_desc = i.Effect;
              } else {
                  sc_desc = "No description given.";
              }
              if (i.Trigger) {
                  sc_desc = `Trigger:${i.Trigger}<br>${sc_desc}`;
              }
          }
          let sc_entry = `<details><summary>${sc_name}</summary><p>${sc_desc}</p></details>`;
          sc_list += sc_entry;
      });
      return sc_list
  }

  function construct_templates(sc_dir) {
      let sc_templates = ``;
      let sc_temp = sc_dir._templates;
      if (!sc_temp || sc_temp.length == 0) {
          sc_templates += "<p>NONE</p>";
      } else {
          sc_temp.forEach(i => {
              let sc_entry = `<p>${i.Name}</p>`;
              sc_templates += sc_entry;
          });
      }

      sc_templates += "<br>";
      return sc_templates
  }

  targets.forEach(target => {
      let sc_dir = target.document.actor._prev_derived.mm
      let hase_table_html = `
      <table>
          <tr>
              <th>HULL</th><th>AGI</th><th>SYS</th><th>ENG</th>
          </tr>
          <tr>
              <td>${sc_dir.Hull || 0}</td><td>${sc_dir.Agi || 0}</td><td>${sc_dir.Sys || 0}</td><td>${sc_dir.Eng || 0}</td>
          </tr>
      </table>
      `
      let stat_table_html = `
      <table>
          <tr>
              <th>Armor</th><th>HP</th><th>Heat</th><th>Speed</th>
          </tr>
          <tr>
              <td>${sc_dir.Armor}</td><td>${sc_dir.CurrentHP}/${sc_dir.MaxHP}</td><td>${sc_dir.CurrentHeat || 0}/${sc_dir.HeatCapacity || 0}</td><td>${sc_dir.Speed}</td>
          </tr>
          <tr>
              <th>Evasion</th><th>E-Def</th><th>Save</th><th>Sensors</th>
          </tr>
          <tr>
              <td>${sc_dir.Evasion}</td><td>${sc_dir.EDefense}</td><td>${sc_dir.SaveTarget}</td><td>${sc_dir.SensorRange}</td>
          </tr>
          <tr>
              <th>Size</th><th>Activ</th><th>Struct</th><th>Stress</th>
          </tr>
          <tr>
              <td>${sc_dir.Size}</td><td>${sc_dir.Activations || 1}</td><td>${sc_dir.CurrentStructure || 0}/${sc_dir.MaxStructure || 0}</td><td>${sc_dir.CurrentStress || 0}/${sc_dir.MaxStress || 0}</td>
          </tr>
      </table>
      `
      console.log(sc_dir)
      let sc_class = (!sc_dir._classes || sc_dir._classes.length == 0) ? "NONE" : sc_dir._classes[0].Name
      let sc_tier = sc_dir.Tier ? sc_dir.Tier : 0
      let sc_templates = construct_templates(sc_dir)
      let sc_list = ``
      if (!sc_dir._features || sc_dir._features.length == 0) {
          sc_list += "<p>NONE</p>";
      } else {
          let sc_origins = new Array
          sc_dir._features.forEach(f => {
              let origin = f.Origin.name
              if (!sc_origins.includes(origin)) {
                  sc_origins.push(origin)
              }
          })
          sc_origins.forEach(o => {
              sc_list += construct_features(sc_dir, o)
          })
      }

      ChatMessage.create({
          user: game.user._id,
          content: `<h2>Scan results: ${sc_dir.Name}</h2>` + `<h3>Class: ${sc_class}, Tier ${sc_tier}</h3>`  + hase_table_html + stat_table_html + `<h3>Templates:</h3>` + sc_templates + `<h3>Systems:</h3>` + sc_list
      });
  })
folder: yxTxiLixDsbyThYC
sort: 112500
flags: {}
ownership:
  default: 0
  2a2IgZ2kiAqXSGqu: 3
_stats:
  systemId: lancer
  systemVersion: 2.0.0-rc1
  coreVersion: '11.315'
  createdTime: null
  modifiedTime: 1710448434625
  lastModifiedBy: ci5PqVPSs3DhZWTF
_key: '!macros!3KPsYon0LoANWX54'
